name: Update AustralianSuper CSV

on:
  schedule:
    - cron: "0 6 * * *"  # runs daily at 6:00 UTC
  workflow_dispatch:

jobs:
  fetch_csv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download CSV
        run: |
          curl -L -o temp.csv "https://www.australiansuper.com//api/graphs/dailyrates/download/?start=12/02/2026&end=31/12/2076&cumulative=False&superType=super&truncateDecimalPlaces=True&outputFilename=auSuper.csv"

      - name: Convert CSV to JSON
        run: |
          node <<EOF
          const fs = require('fs');

          const csv = fs.readFileSync('temp.csv', 'utf8');
          const lines = csv.split('\n').map(l => l.trim()).filter(Boolean);
          const headers = lines[0].split(',').map(h => h.trim());
          const data = lines.slice(1).map(line => {
            const cols = line.split(',').map(c => c.trim());
            const obj = {};
            headers.forEach((h,i) => obj[h] = cols[i] ?? '');
            return obj;
          });

          fs.writeFileSync('auSuper.json', JSON.stringify(data, null, 2));
          EOF

      - name: Commit JSON
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add auSuper.json
          git commit -m "Daily update CSV â†’ JSON" || echo "No changes"
          git push
